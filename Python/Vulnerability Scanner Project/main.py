from network_scanner import network_scan, save_results_to_csv
from web_scanner import check_sql_injection
from port_scanner import scan_ports, save_ports_to_csv
from datetime import datetime

def display_devices(devices):
    """
    Displays the list of discovered devices in a user-friendly format.

    :param devices: A list of dictionaries containing IP, MAC addresses, and hostnames of devices.
    """
    if devices:
        print(f"\nFound {len(devices)} device(s):\n")
        print(f"{'IP Address':<15} {'MAC Address':<17} {'Hostname':<20}")
        print("-" * 55)
        for device in devices:
            print(f"{device['ip']:<15} {device['mac']:<17} {device['hostname']:<20}")
    else:
        print("\nNo devices found on the network.")

def run_network_scan():
    ip_range = input("Please enter the IP range to scan (e.g., 192.168.0.1/24): ")
    if not ip_range:
        print("IP range is required to proceed.")
        return
    print(f"\nScanning network: {ip_range}")
    devices = network_scan(ip_range)
    display_devices(devices)
    print("\nNetwork scan completed.")

    if devices:
        save_choice = input("\nDo you want to save the scan results to a CSV file? (yes/no): ").strip().lower()
        if save_choice == "yes":
            save_results_to_csv(devices, filename)
            # Automatically generate the filename based on the current date
            timestamp = datetime.now().strftime("%H%M%d%m%Y")
            filename = f"{timestamp}_netscan.csv"
            save_results_to_csv(devices, filename)
            print(f"Results saved to {filename}")
    

def run_sql_injection_test():
    url = input("Please enter the URL to test for SQL Injection (e.g., http://example.com/login.php?username=): ")
    
    # Add 'http://' if the user didn't include a scheme in the URL
    if not url.startswith(("http://", "https://")):
        url = "http://" + url

    print(f"\nTesting URL for SQL Injection: {url}")
    is_vulnerable = check_sql_injection(url)
    
    if is_vulnerable:
        print(f"The URL {url} is vulnerable to SQL Injection.")
    else:
        print(f"The URL {url} is not vulnerable to SQL Injection.")
    
    print("\nSQL Injection test completed.")

def run_port_scanner():
    print("Scanning ports 1 through 1024 (change scope in the code if needed).")
    ip = input("Please enter the IP address to scan for open ports: ")
    port_range = range(1, 1025)
    print(f"Scanning IP: {ip}")
    open_ports = scan_ports(ip, port_range)
    
    if open_ports:
        print(f"Open ports on {ip}:")
        for port in open_ports:
            print(f"Port {port} is open")
        
        save_choice = input("\nDo you want to save the scan results to a CSV file? (yes/no): ").strip().lower()
        if save_choice == "yes":
            timestamp = datetime.now().strftime("%H%M%d%m%Y")
            filename = f"{timestamp}_portscan.csv"
            save_ports_to_csv(ip, open_ports, filename)
    else:
        print(f"No open ports found on {ip}.")
        
def main():
    print("Welcome to the Cybersecurity Tool Suite")
    while True:
        print("\nChoose an option:")
        print("1. Run Network Scanner")
        print("2. Run SQL Injection Test")
        print("3. Run Port Scan")
        print("4. Exit")
        
        choice = input("Enter your choice (1, 2, 3, or 4): ")

        if choice == "1":
            run_network_scan()
        elif choice == "2":
            run_sql_injection_test()
        elif choice == "3":
            run_port_scanner()
        elif choice == "4":
            print("Exiting the Cybersecurity Tool Suite. Goodbye!")
            break
        else:
            print("Invalid choice. Please enter 1, 2, 3, or 4.")
        
        # Ask if the user wants to perform another action
        another = input("Do you want to perform another action? (yes/no): ").strip().lower()
        if another != "yes":
            print("Exiting the Tool. Goodbye!")
            break

if __name__ == "__main__":
    main()
